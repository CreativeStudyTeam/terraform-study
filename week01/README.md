# 왜 테라폼인가?

- 데브옵스의 등장
- 코드형 인프라란?
- 코드형 인프라의 장점
- 테라폼의 작동 방식
- 테라폼과 다른 코드형 인프라 도구 비교

---

## 1. 데브옵스의 등장 - 01

### 기존
- 운영팀 : 하드웨어 관리
- 개발팀 : 소프트웨어 개발

개발팀: 만든 애플리케이션을 운영팀에게 전달
운영팀: 어떻게 배포하고 운영할지 전략 수립

#

> 하드웨어는 그렇다 치는데...

##  애플리케이션이나 의존성(dependencies)설치와 같은 **소프트웨어 작업**도 서버에 수동으로 명령 실행..?!

---

## 1. 데브옵스의 등장 - 02

### 수동 작업의 문제

- 조직이 커지면 서버가 늘어나고 배포작업은 느리고 고통스럽고 예측 불가능
- 모든 서버가 동일한 환경이 아닌 미묘하게 다른 configuration drift 발생

## **내 컴퓨터에서는 잘 동작하는데..?**

### -> 배포 주기를 늦추기 시작
1개월에 한번 -> 6개월에 한번 -> ...

## **클라우드 서비스의 등장!**

---

## 1. 데브옵스의 등장 - 03

데브옵스는 소프트웨어를 효율적으로 전달하는 프로세스다.

핵심가치
- 문화 (Culture)
- 자동화 (Automation)
- 측정 (Measurement)
- 공유 (Sharing)

## **CAMS**

목표: 배포(software delivery)를 최대한 자동화 하는것

---

## 2. 코드형 인프라 - 01

### IaC(Infrastructure as Code, 아에이씌)


### 코드형 인프라 도구의 범주

- 애드훅 스크립트
- 구성 관리 도구
- 서버 템플릿 도구
- 오케스트레이션 도구
- 프로비전 도구

---

## 2. 코드형 인프라 - 02

- 애드훅 스크립트 : 작성된 스크립트를 서버에서 수동으로 실행
- 구성 관리 도구 : shell 파일이 아닌 yml 파일 (코딩 컨벤션, 멱등성, 분산 구조)

  ![width:500px](https://user-images.githubusercontent.com/33514304/128586558-39d4361d-042f-4c59-b444-fe77e54e3dc6.png)

---

## 2. 코드형 인프라 - 03

- 서버 템플릿 도구 : 도커 같은 필요한 환경을 스냅샷으로 만든 이미지들을 생성하여 이미지를 설치할 수 있는 도구
- **immutable infrastructure 불변 인프라**

- 가상머신, 컨테이너

  ![width:500px](https://user-images.githubusercontent.com/33514304/128586634-cd1ee702-b9f0-4caa-81f3-414b4964f0e9.png)

---

## 2. 코드형 인프라 - 04

- 오케스트레이션 도구

컨테이너를 하드웨어에 효율적으로 배포하기
롤링 배포, 블루 그린, 카나리 배포 등등 효율적으로 업데이트 하거나 롤백하기
자동 복구, 자동확장, 로드밸런싱
서로 다른 네트워크에 있어도 VM과 컨테이너가 서로 식벼랗고 통신할 수 있도록 하기

### => **Kubernetes** (Amazon EKS, Google GKE, Azure AKS)

---

## 2. 코드형 인프라 - 05

- 프로비전 도구

프로비저닝 은 인프라 에서 자주 나오는 용어로 사전적인 의미로는 공급, 준비, 대비, 식량 이란 의미로 IT 에서 의미는 특정 서비스를 제공받기 위하여 서비스 실행부터 시작해 서비스를 제공받기 전 단계까지 처리되는 일련의 절차를 말한다.(위키백과)

- 테라폼, CloudFormation, 오픈스택 히트
- 서버만 생성하는 것이 아니라 데이터베이스, 캐시, 로드밸런서, 큐, 모니터링, 서브넷 구성, 방화벽 설정, 라우팅 규칙 설정, SSL 등 거의 모든 부분을 프로비저닝 가능

```tf
// 구문에 익숙하지 않아도 괜찮습니다. ami는 서버에 배포할 AMI의 ID를 지정하는 매개 변수입니다. user_data는 웹서버가 부팅될 때 실행되는 bash 스크립트입니다.

resource "aws_instance" "app" {
  instance_type      = "t2.micro"
  availability_zone  = "ap-northeast-2"
  ami                = "ami-0c55b159cbfafe1f0"

  user_data = <<-EOF
                #!/bin/bash
                sudo service apache2 start
                EOF
}
```

---

## 3. 코드형 인프라의 장점

- 자급식 배포
- 속도와 안정성
- 문서화
- 버전 관리
- 유효성 검증
- 재사용성
- 행복

---

## 4. 테라폼의 작동 방식


terraform 바이너리 파일
- 테라폼을 쓰면 인프라를 배포하기 위해 추가적인 다른 인프라를 생성할 필요가 없음
- 테라폼 바이너리 파일 자체가 API서버라고 볼 수 있음

```
resource "aws_instance" "example" {
  ami           = "ami-0c55v159cbfafe1f0"
  instance_type = "t2.micro"
}
resource "google_dns_record_set" "a" {
  name          = "demo.google-example.com"
  managed_zone  = "example-zone"
  type          = "A"
  ttl           = 300
  rrdatas       [aws_instance.example.public_ip]
}
```

테라폼 구성 파일을 이용하여 API 호출하면 인프라가 구성되는 방식
`$ terraform apply`

---

## 5. 수 많은 코드형 인프라 도구 중 테라폼을 고른 이유 - 01

### 5.1 구성관리 vs 프로비저닝

구성관리는 서버 구성을 관리할 수 있는 도구지만 인프라를 자동으로 구성되도록 할 수 는 없다.
요즘에는 점진적으로 프로비저닝 기능을 추가하고 있는 추세라서 구분하기 애매하다.
***프로비저닝 하라고 만들어 둔 프로비전 도구를 쓰자***

### 5.2 가변 인프라 vs 불변 인프라

최대한 구성 드리프트(configuration drift)를 피해야한다.
(완벽은 불가능)

최소한 배포되는 순간 부터만이라도 모든 서버가 동일한 환경으로 구성되길 바란다면
불변 인프라를 구성할 수 있는 **테라폼**

---

## 5. 수 많은 코드형 인프라 도구 중 테라폼을 고른 이유 - 02

### 5.3 절차적 언어 vs 선언적 언어

선언적 언어: 구현하려는 최종 상태를 지정하는 코드

즉, 절차적 언어 도구의 설정 파일을 10개에서 15개로 적용하면 25개가 떠버린다. 10개는 지워야함
그러나 선언적 언어 도구의 설정 파일은 10개에서 15개로 늘리면 5개가 늘어 실제 서버 15개 구성

테라폼은 선언적 언어이면서도 모듈, 3항 연산자, 내장함수, 반복문 등등을 작성할 수 있음

### 5.4 마스터 서버 유무
마스터 서버가 없는 테라폼은 인프라를 위한 인프라를 구성하지 않아도 된다.

### 5.5 에이전트 유무
역시 마찬가지로 인프라를 위한 소프트웨어를 서버에 설치할 필요 없다.

---

## 5. 수 많은 코드형 인프라 도구 중 테라폼을 고른 이유 - 03

### 5.6 커뮤니티

38쪽 하단 표, 압도적인 테라폼의 성장률

### 5.7 성숙 vs 최첨단

https://github.com/hashicorp/terraform
- 현재 테라폼 1.0.4로 공식 릴리즈 상태
- 약점 제거 완료

### 5.8 콤비네이션

앤서블 + 테라폼
패커+ 테라폼
도커 + 패커 + 테라폼


---


시간이 남는다면...

#

제가 시도해보고 있는 code-server

https://github.com/creco-org/terraform-code-server

게더타운 화면공유 어떻게 하나요..? ㅋㅋㅋ
